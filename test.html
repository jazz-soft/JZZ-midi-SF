<!DOCTYPE html>
<html lang=en>
<head>
<title>SF2 View</title>
<script src="node_modules/jzz/javascript/JZZ.js"></script>
<script src="javascript/JZZ.midi.SF2.js"></script>
<style>
.knob { width:1em; height:1em; display:inline-block; margin-left:.2em; margin-right:.2em; }
.knobb { width:1em; height:1em; display:inline-block; margin-left:.2em; margin-right:.2em; text-align:center; background-color:#ddd; line-height:1em; }
.title { min-width:8em; display:inline-block; margin-right:.2em; font-weight:bold; }
.drop { margin-left:2em; }
.hide { visibility:hidden; }
</style>
</head>

<body>

<h1>SF2 View</h1>
<p id=panel>Please enable JavaScript!</p>

<script>
var panel = document.getElementById('panel');
panel.innerHTML = 'Please run <tt style="background-color:#bbf;"><b>npm install</b></tt> to enable this test.';
var SF = JZZ.MIDI.SF2;
panel.innerHTML = '';
var input = document.createElement('input');
input.type = 'file';
input.accept = '.sf2,.sf3';
input.addEventListener("change", load_file);
panel.appendChild(input);
panel.appendChild(document.createElement('hr'));
var display = document.createElement('div');
panel.appendChild(display);
var gui;

function load_file() {
  if (window.FileReader) {
    var reader = new FileReader();
    reader.onload = function(e) { load_sf(e.target.result); };
    reader.readAsArrayBuffer(input.files[0]);
  }
  else alert('File API is not supported in this browser.');
}
function load_sf(data) {
  try {
    var sf = new SF(data);
    console.log(sf.toString());
    display_sf(sf);
  }
  catch (err) { alert(err.message); }
}
function display_sf(sf) {
  display.innerHTML = '';
  gui = new Cell(display, 0, 'SOUNDFONT', sf.data.ifil[0] + '.' + ('0' + sf.data.ifil[1]), sf);
  gui.populate = populate;
  gui.expand();
}

function Cell(parent, type, title, text, ref) {
  var self = this;
  this.div = document.createElement('div');
  var knob = document.createElement('span');
  knob.className = type == 1 ? 'knobb' : 'knob';
  if (type == 1) {
    knob.innerHTML = '+';
    knob.addEventListener('click', function() {
      if (self.exp) {
        self.collapse();
        knob.innerHTML = '+';
      }
      else {
        self.expand();
        knob.innerHTML = '-';
      }
      self.exp = !self.exp;
    });
  }
  this.div.appendChild(knob);
  var span = document.createElement('span');
  span.className = 'title';
  span.innerHTML = title;
  this.div.appendChild(span);
  span = document.createElement('span');
  span.innerHTML = text;
  this.div.appendChild(span);
  this.ref = ref;
  parent.appendChild(this.div);
}
Cell.prototype.expand = function() {
  if (!this.more) {
    this.more = document.createElement('div');
    this.more.className = 'drop';
    if (this.populate) this.populate();
    this.div.appendChild(this.more);
  }
  this.more.classList.remove('hide');
}
Cell.prototype.collapse = function() {
  this.more.classList.add('hide');
}
function populate() {
  this.cells = [];
  var c;
  this.cells.push(new Cell(this.more, 0, 'Target', this.ref.data.isng));
  this.cells.push(new Cell(this.more, 0, 'Bank Name', this.ref.data.INAM));
  if (this.ref.data.irom) this.cells.push(new Cell(this.more, 0, 'ROM Name', this.ref.data.irom));
  if (this.ref.data.iver) this.cells.push(new Cell(this.more, 0, 'ROM Version', this.ref.data.iver));
  if (this.ref.data.ICRD) this.cells.push(new Cell(this.more, 0, 'Date', this.ref.data.ICRD));
  if (this.ref.data.IENG) this.cells.push(new Cell(this.more, 0, 'Designers', this.ref.data.IENG));
  if (this.ref.data.IPRD) this.cells.push(new Cell(this.more, 0, 'Product', this.ref.data.IPRD));
  if (this.ref.data.ICOP) this.cells.push(new Cell(this.more, 0, 'Copyright', this.ref.data.ICOP));
  if (this.ref.data.ICMT) this.cells.push(new Cell(this.more, 0, 'Comments', this.ref.data.ICMT));
  if (this.ref.data.ISFT) this.cells.push(new Cell(this.more, 0, 'Software', this.ref.data.ISFT));
  this.cells.push(new Cell(this.more, 2, 'Sample Data', '[ ' + this.ref.data.smpl.length + ' ]'));
  c = new Cell(this.more, 1, 'Samples', '', this.ref.Samples);
  c.populate = populate_samples;
  this.cells.push(c);
}
function populate_samples() {
  this.cells = [];
  var i, c;
  for (i = 0; i < this.ref.length; i++) {
    c = new Cell(this.more, 0, this.ref[i].name, '[ ' + this.ref[i].sample.length + ' ]');
    this.cells.push(c);
  }
}
</script>

</body>
</html>
